version: 2.1
orbs:
  aws-s3: circleci/aws-s3@1.0.11
jobs:
  build:
    docker:
      - image: circleci/node:10.16.3
    steps:
      - checkout # special step to check out source code to working directory
      - run:
          name: update-npm
          command: "sudo npm install -g npm@latest"
      - restore_cache: # special step to restore the dependency cache
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: install-npm
          command: npm install
      - save_cache: # special step to save the dependency cache
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - run: # run tests
          name: test
          command: npm test
      # - run: # run coverage report to coveralls
      #     name: code-coverage
      #     command: npm run coverage
      - run: npm run build
      - run: ls -la
      - run: echo pwd
      - aws-s3/sync:
          from: dist
          to: 's3://bucketofyanggu/dist'
          aws-region: 'ap-southeast-2'
          arguments: |
            --acl public-read \
            --cache-control "max-age=86400"
          overwrite: true
